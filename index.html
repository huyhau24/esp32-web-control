<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ESP32 MQTT Chat (HiveMQ)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#f7fafc;color:#111}
    .card{max-width:820px;margin:0 auto;background:#fff;padding:14px;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,0.06)}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    #status{font-weight:600}
    #chatbox{height:320px;border:1px solid #e6e9ef;padding:10px;overflow:auto;background:#fcfeff;border-radius:6px}
    .msg{margin:8px 0;padding:8px 10px;border-radius:8px;max-width:78%}
    .from-me{background:#e6f7ff;margin-left:auto}
    .from-esp{background:#fff7e6;margin-right:auto}
    .meta{font-size:12px;color:#666;margin-bottom:6px}
    .controls{display:flex;gap:8px;margin-top:10px}
    input[type="text"]{flex:1;padding:9px;border-radius:6px;border:1px solid #cfd8e3}
    button{padding:8px 12px;border-radius:6px;border:none;background:#0b76ff;color:#fff;cursor:pointer}
    button.secondary{background:#6c757d}
    .hint{margin-top:8px;font-size:13px;color:#444}
  </style>
</head>
<body>
  <div class="card">
    <div class="top">
      <h2>ESP32 Chat (HiveMQ)</h2>
      <div id="status">Đang kết nối...</div>
    </div>

    <div id="chatbox" aria-live="polite"></div>

    <div class="controls">
      <input id="msgInput" type="text" placeholder="Gõ tin nhắn (tối đa 32 ký tự cho LCD)" maxlength="200" />
      <button id="sendBtn">Gửi tới ESP32</button>
      <button id="sampleBtn" class="secondary">Gửi mẫu "HELLO MQTT"</button>
    </div>
    <div class="hint">
      Lưu ý: tin gửi tới ESP32 sẽ bị cắt xuống 32 ký tự (LCD 2x16 = 32). Không để credential thật trong repo public.
    </div>
  </div>

<script>
/* ==== CẤU HÌNH (thay bằng thông tin của bạn) ==== */
const brokerHost = '78f596846662492495a9ce2ddb5b7027.s1.eu.hivemq.cloud';
const brokerPort = 8884;
const wsPath = 'Esp321234567@';
const brokerUrl = `wss://${brokerHost}:${brokerPort}${wsPath}`;

// Thay bằng user bạn tạo cho web (CHÚ Ý: không để repo public nếu dùng password thật)
const MQTT_USERNAME = 'webchat_user';
const MQTT_PASSWORD = 'WebChat2025!';

const TOPIC_TO_ESP = 'esp32/lcd';      // web publish -> esp subscribe
const TOPIC_FROM_ESP = 'esp32/button'; // web subscribe <- esp publish

/* ==== KẾT NỐI ==== */
const clientId = 'webchat_' + Math.random().toString(16).slice(2,9);
const options = {
  clientId,
  username: MQTT_USERNAME,
  password: MQTT_PASSWORD,
  keepalive: 60,
  reconnectPeriod: 2000,
  clean: true,
  connectTimeout: 30 * 1000
};

const client = mqtt.connect(brokerUrl, options);

const statusEl = document.getElementById('status');
const chatbox = document.getElementById('chatbox');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const sampleBtn = document.getElementById('sampleBtn');

function addChatMessage(who, text) {
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (who === 'me' ? 'from-me' : 'from-esp');
  const meta = document.createElement('div');
  meta.className = 'meta';
  const now = new Date();
  meta.textContent = `${who === 'me' ? 'Bạn' : 'ESP32'} • ${now.toLocaleTimeString()}`;
  const body = document.createElement('div');
  body.textContent = text;
  wrapper.appendChild(meta);
  wrapper.appendChild(body);
  chatbox.appendChild(wrapper);
  chatbox.scrollTop = chatbox.scrollHeight;
}

function prepareForLCD(s) {
  s = s.replace(/\r?\n/g, ' ');
  if (s.length > 32) s = s.slice(0, 32);
  return s;
}

/* MQTT events */
client.on('connect', function () {
  statusEl.textContent = `Kết nối: ${brokerHost}`;
  client.subscribe(TOPIC_FROM_ESP, function (err) {
    if (err) addChatMessage('esp', '[Lỗi subscribe] ' + err.message);
  });
});

client.on('reconnect', function () { statusEl.textContent = 'Đang kết nối lại...'; });
client.on('close', function () { statusEl.textContent = 'Đã ngắt kết nối'; });
client.on('error', function (err) { statusEl.textContent = 'Lỗi: ' + err.message; console.error(err); });

client.on('message', function (topic, message) {
  const text = message.toString();
  if (topic === TOPIC_FROM_ESP) addChatMessage('esp', text);
  else addChatMessage('esp', `[${topic}] ${text}`);
});

/* Gửi tin */
function sendToESP(text) {
  const payload = prepareForLCD(text);
  client.publish(TOPIC_TO_ESP, payload, {qos: 0}, (err) => {
    if (err) addChatMessage('esp', '[Lỗi gửi] ' + err.message);
    else addChatMessage('me', payload);
  });
}

sendBtn.addEventListener('click', () => {
  const t = msgInput.value.trim();
  if (!t) return;
  sendToESP(t);
  msgInput.value = '';
});

sampleBtn.addEventListener('click', () => { sendToESP('HELLO MQTT'); });

msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); sendBtn.click(); } });
</script>
</body>
</html>
